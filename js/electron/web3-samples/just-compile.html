<html>
    <head>
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.min.css" rel="stylesheet">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    </head>
    <body>
        <div id="app">
            <v-app id="inspire">
                <v-navigation-drawer v-model="drawer" fixed app>
                    <v-list dense>
                        <v-list-tile @click="drawer = !drawer; compile()">
                            <v-list-tile-content>
                                <v-list-tile-title>Compile</v-list-tile-title>
                            </v-list-tile-content>
                        </v-list-tile>
                    </v-list>
                </v-navigation-drawer>
                <v-toolbar color="indigo" dark fixed app>
                    <v-toolbar-side-icon @click.stop="drawer = !drawer"></v-toolbar-side-icon>
                    <v-toolbar-title>Solidity {{compilerRequired}}</v-toolbar-title>
                  <v-spacer></v-spacer>
                    <v-btn light @click="constantCompilation = !constantCompilation" icon>
                           {{ constantCompilation ? "stop compiling" : "compile" }} 
                        <v-icon>refresh</v-icon>
                    </v-btn>
                </v-toolbar>
                <v-content>
                    <v-container fluid fill-height>
                        <v-layout justify-center align-content-end>
                            <v-flex xs12>
                                <!-- <v-textarea v-on:change="compile()" no-resize auto-grow outline name="input-7-4" label="solidity:" v-model="solidityCode"></v-textarea> -->
                                <v-textarea no-resize auto-grow outline name="input-7-4" label="solidity:" v-model="solidityCode"></v-textarea>
                                <!-- <v-textarea no-resize auto-grow outline name="input-7-4" :value="JSON.stringify(compilationErrors, null, 2)"></v-textarea></span> -->
                                
                                <v-container fluid grid-list-lg>
                                    <v-layout row wrap>
                                        <v-flex v-for="error in compilationErrors">
                                            <v-card :color="error.severity === 'error' ? '#ff9e80' : '#e0e0e0'" hover elevation=10> 
                                                <v-card-title primary-title>
                                                    <div>
                                                        <h3 class="headline mb-0">{{error | errorHeader}}</h3>
                                                        <div v-for="(msg, i) in error.formattedMessage.split('\n')">{{msg | errorBody(i)}}</div>
                                                    </div>
                                                </v-card-title>
                                            </v-card>
                                        </v-flex>
                                    </v-layout>
                                </v-container>
                            </v-flex>
                        </v-layout>
                    </v-container>
                </v-content>

                <!-- <v-bottom-sheet hide-overlay lazy persistent   v-model="sheet"> -->
                <!-- <v-bottom-sheet hide-overlay lazy persistent v-if="!compilationHasErrors"> -->
                    
                <v-bottom-sheet hide-overlay persistent v-model="compilationHasNoErrors">
                    <v-list>
                    <!-- <v-list three-line> -->
                        <!-- <v-list-tile key="abi" @click="sheet = false"> -->
                        <v-list-tile key="abi">    
                            <v-list-tile-action>
                                <v-icon color="pink">star</v-icon>
                            </v-list-tile-action>
                            <v-list-tile-content>
                                <v-list-tile-title>abi</v-list-tile-title>
                                <v-list-tile-sub-title>{{compiledContractAbi}}</v-list-tile-sub-title>
                            </v-list-tile-content>
                        </v-list-tile>
                        <!-- <v-list-tile key="bytecode" @click="sheet = false"> -->
                        <v-list-tile key="bytecode">    
                            <v-list-tile-action>
                                <v-icon color="pink">star</v-icon>
                            </v-list-tile-action>
                            <v-list-tile-content>
                                <v-list-tile-title>bytecode</v-list-tile-title>
                                <v-list-tile-sub-title>{{compiledContractBytecode}}</v-list-tile-sub-title>
                            </v-list-tile-content>
                        </v-list-tile>        
                    </v-list>
                </v-bottom-sheet>
                <!-- <v-footer color="indigo" app>
                    <span class="white--text">&copy; 2017</span>
                </v-footer> -->
            </v-app>
        </div>
        <!-- https://github.com/ethereum/solc-js/issues/31 -->
        <!-- https://stackoverflow.com/questions/53795971/solidity-solidity-code-to-input-json-description -->
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.js"></script>          
        <script type="text/javascript" src="https://ethereum.github.io/solc-bin/bin/list.js"></script>
        <script type="text/javascript" src="https://ethereum.github.io/solc-bin/bin/soljson-v0.4.18+commit.9cf6e910.js"></script>
        <script type="text/javascript" src="assets/js/wr.js"></script>
        <script>
            // Vue.filter('errorHeader', );
            // Vue.filter('errorBody', function(errorObj){
            //     var msg = errorObj.formattedMessage;
            //     if (msg) {
            //         return msg.split(":").slice(1, 4).join(":");
            //     } else {
            //         return "";
            //     }
                
            // });            
            new Vue({
                el:"#app", 
                watch: {
                    solidityCode: function(oldcode, newCode){
                        this.compile();
                    }
                },
                filters: {
                    errorHeader: function(errorObj){
                        var msg = errorObj.formattedMessage;
                        return msg ? msg.split(":").slice(1, 4).join(":") : "";
                    },
                    errorBody: function(msg, line){
                        if (line === 0) {
                            return  msg.replace(msg.split(":").slice(0, 4).join(":") + ":", "");
                        } else {
                            return msg;
                        }
                    }
                },
                data: {
                    constantCompilation: true,
                    sheet: false,
                    drawer: false,
                    compilationResult: undefined,
                    solidityCode: `pragma solidity ^0.4.18;
                        contract HelloWorld {
                        function displayMessage() constant returns (string) {
                            return "Whale hello there!";
                        }
                    }`
                },
                computed: {
                    compilationHasNoErrors () {
                        if (!this.compilationResult) { return false; }
                        if (!this.compilationResult.errors) { return false; }
                        if (!Array.isArray(this.compilationResult.errors)) { return false; }
                        if (this.compilationResult.errors.filter(err => err.severity === "error").length) { return false; }
                        return true;
                    },
                    compilationErrors () {
                        if (this.compilationResult) {
                            return this.compilationResult.errors;
                        }
                    },                                         
                    isCompilerVersionNeededDetected() {
                        var result = "solidity";
                        if (this.solidityCode.startsWith("pragma")) {
                            var pragmaDirective = this.solidityCode.split(";")[0];
                            if (/[0-9\.]+/.exec(pragmaDirective)) {
                                return true;
                            }
                        }
                        return false;
                    },                    
                    compilerRequired() {
                        var result = "";
                        if (this.solidityCode.startsWith("pragma")) {
                            var pragmaDirective = this.solidityCode.split(";")[0];
                            var matches = /[0-9\.]+/.exec(pragmaDirective);
                            if (matches) {
                                result = matches[0];
                            }
                        }
                        return result;
                    },
                    compiledContractBytecode() {
                        var res = this.compilationResult;
                        if (res && res.contracts && res.contracts[""]) {
                            var contracts = this.compilationResult.contracts[""];
                            var firstContractName = Object.keys(contracts)[0];
                            var compiledContract = contracts[firstContractName];
                            var bytecode = compiledContract.evm.bytecode.object;
                            return bytecode;
                        } else {
                            return "";
                        }
                    },
                    compiledContractAbi() {
                        var res = this.compilationResult;
                        if (res && res.contracts && res.contracts[""]) {
                            var contracts = this.compilationResult.contracts[""];
                            var firstContractName = Object.keys(contracts)[0];
                            var compiledContract = contracts[firstContractName];
                            var {abi} = compiledContract;
                            return abi;
                        } else {
                            return "";
                        }
                    },
                    compilationResultToTreeView() {
                        //return [{id: 1,name: 'Applications :',children: [{ id: 2, name: 'Calendar : app' },{ id: 3, name: 'Chrome : app' },{ id: 4, name: 'Webstorm : app' }]}];
                        var objectToVuetifyTreeview = n => {
                            var expandChildren = obj => {
                                var result = [];
                                if (typeof obj === "object") {
                                    for (key in obj) {
                                        n += 1;
                                        var child = obj[key];
                                        var children = expandChildren(child);
                                        if (children.length === 0) {
                                            result.push({
                                                id: n, 
                                                name: key
                                            });
                                        } else if (children.length === 1 && !children[0].children) {
                                            result.push({
                                                id: n, 
                                                name: key + ":" + children[0].name
                                            });
                                        } else {
                                            result.push({
                                                id: n, 
                                                name: key, 
                                                children
                                            });
                                        }
                                    }
                                } else {
                                    n += 1;
                                    result.push({
                                        id: n, 
                                        name: obj
                                    });
                                }
                                return result;
                            }
                            return expandChildren;
                        }
                        return objectToVuetifyTreeview(0)(this.compilationResult);
                    }
                },
                methods: {
                    escapeHelper (str) {
                        return escape(str);
                    },
                    compile() {
                        var solc = wrapper(window.Module);
                        const input = {
                            language: 'Solidity',
                            sources: { ['']: { content: this.solidityCode } },
                            settings: { outputSelection: { '*': { '*': ['*'] } } }
                        }
                        this.compilationResult = JSON.parse(solc.compile(JSON.stringify(input)));
                    }
                }
            });
        </script>
    </body>
</html>