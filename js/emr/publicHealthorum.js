var abiB64 = 'H4sIAAAAAAAAA9VXTW/bMAz9Lzr71GE75FYEBQoMBYx12KXoQZHpRJgteRSV1ij63yc7/upi2Wr6Ee9oiE/iI/lI+u6JCa0McUVslfLMQMSkKiwZtrp7YornwFaM9G9QLGJUFtWnIZRqy56jzqDgJMFd0ZnwJEEwhj3fR60Nwh8Lhi6FqA4ipi017zibgpd8k0Hng/OI4MYS38hMUungSqvWqHsltUqQ1Kp2JYCH382eyo6bXW+wKQnMl4shjy3QzyYePYUO3kOloouv34ZXD67VOnvtSRv1T4uWAdxLATHqvUwAZ5K7dzG5fYk4a6rtJpPiO5SjAWyMHJHbI5L/RV2Ocrm6+XEe/z2a6Z1H4Im/xh9QEviPEa5UQCaPRbmA/PUeShMfrFyppTKDdaYNJHNN5BCLRUre9cF/xBMPNDfJ6tNbmb+E+jJT8HDZsJzSoTOLQ3qL2HG1hSbnrhNqWxfIQqvTJbMtz3MnkdCO1+ZUtFPU+TU8zsqpak2BLhcWP7ilv1JtMWAujamcCOoay1gvfOkUPdK2q9JRPtc7jnNkh+gPz2rgVhF32X9vvXc+nXxdTROtII31jdwZlbm2Zoy3VAk8ujHVHs0OfA9gUg4eTCMPF+0ghdQ/Kb8AZSphsGzAvnr3VKJv8Dtwbz4MJjd53s9pnSXNwJkcaLPoiTnnh1dj9PTHe/RJj4esisWLkbyux/TC68WPhRyvZ34MnMl4dd3/BS6Pm4b9DwAA';
var binB64 = 'H4sIAAAAAAAAA81Zf2wb1R2/d3eJk0pDTuZzCEkapyKxgYI68oNFW1HXjjHYNGzH9k09tL1HuyEVpFbpirZu1O/unDTll57dVGqlThOdWKUh+AdNVTcmTTBEFaioSqfuH1R1WyttQAvtNDa1hX3fnc/xb/tyDuQiX77x3ft+P98f7/vjBVO8IT5GFSL4VSzQG1p0FH4RJKzSE/rOz6pcYm+QmVWfBMUeloySyAuUCBgLk1i4KmDOH8sTfiKcAgHjv0BCnYvJWyxGdEvP8XPfDBDhLyrdcuebPzseIOgHQH7t+HU5QMT7gPz2Kw9dAXIOyAf+d+IZID8GMnXu3PYAkXYDue2ZUy8FiNwJ5OP7Ah8AuRXIHfL49QBpCwH55NCePwN5Gcjn9oydDZD2F4HMopn3AsT3LJDHvhL2BUhHGshre9+ZB/JPqmYZyTLY+bzBCHoYy3RC0hGjdJzhEGIGyhOU4kGEQzQri/An3hBjOtzjdH8uy3Q9Dt+ZJjUy9xgoG7WubC6bY3S8un0tlrAS3iOdt6U0wQKCthWAvFQEpD4LOo6F3hKGN0VTGgCkMxasjAKXDbBAUfgYumTETV2PWd9kozRm62maWNBM3a8Q0adSA8X0DII3AArA+iClcd1YFLRneDAIoMUxeEuiMYxMHJJ4vEm9wTxPLXrANgaHk5XYVUtNMeaoKc42rSZXzH/IsZQ4X2BxucUu44K6ThcE3XAEST914ZJWAel+xwEizTpAZF8RkGLf03FFqU63Co6y04EjKwU4D7ry4c2SHZxGIRizZeEh7yiwfsEd64dt1s1Ft3yhPLrlhcrobuuuF9258tBuW+tgb/vwc04lrfPyzb92vNx2zVGnfZ0rV/RPunFF+45yV7QnK13R/ktXrmg/5mD3dS9DihgYcKOhL16uoe+eSg19aVca+g4VNLzkIjc19t7gHbZuSy8dHRvL9e0IV+rbsb2evvOVlaPjaUfjjt+W+zSPfejn+fxSNbd0vO0w6AwvQ1AMn+I7BwtYNC0Mi4bRcMj0Kwrp3KLSmAE8+GLbNPBEygGgewH4oiForxEL6plYkBo9M3FbDotaCoU4b1PSsTC7+WMFtOo8qq4Hte6F2w3Nttl64A1+6HzV1tdSM1ZkJxCLsIiF0erRUP1bS3dm3bEQwiLcTV6A+KfsmYASAYXc9B0Vi3Q5pejQp7ZCD6OGBAR3lmDcJUzGnwW9yuL8vKwX4J7v6bHdwCuK1awvsxHQCjMC+tyNIHreL17VRrCJExjpGAVhVhBECRzBZPKlI7ClychJyK/p2Ol3u96LHjh6+I37R47s/K55/9RkLnmXdmnrWrp2/pM9c7o5aiX2Eh1rzIB1MBmuV+wvyuXP8xyV4vMXZErMrbrXo89ma2chzn7OI/u9LpLDPo+y5lzswac8ytpXM9RplUCrURULRdGotkYhfl2FlX7iT6nwPTUTsmjGs7w2w6OUBnWQYQHWg2CmwY6OMx7ovNMwu4h/q2owCboFeE3L18D9+Z/cgew8NEUpq95635nud0EzWXklQKueK8FwNXCRritGob+t0sN0h2v1MN1isz2MnQlAPSZXBwHdQ/fbEDmeSwXLK0C6F3ieDCcgT2o8apCicOdkvuBCVrypFQXUVrarHJcXp8uwM6mzQU3r6xow9XiUgZH1BKJGkoJnYPcZ0uKOxCJPFAz62ywDZwu8qS82amDQMuoZMCqPB3iIFvfCkk4d4Uo/9sfpy/c9/tofruw6P6H87pGLF/7ZORr8yeGzGx84c/XOXZfOG6NWf+3ede6N2ty8o9xdPu8oPZXzjvLDpucdXiNbkdkaVMcAoAqOqeBYezN4ESWVVUMIZk0hPTfU1kwatbXgM4CxnCJQrfSuL7PU6pmbLqdUcXFv91wrSpjRxXj0kpnKg4RFYRwFxhh7q3N5Np4jTarp6hq1snd13VrZO1WrVvbe1cpa2T+mUq/VrCit9/6n4Pr0iafeP3T5zKu+vucOv5FctX7NP371xMJDp29PHkkcM798cloe9WpzAWUye7mWs0vKzjNLWsU/GV3KxOd0vbJvdRJ91Y62b8ruaPsiFR1t31SjjrZvoqSjBQhmfLZeael7try09E1Xlpa+39crLRlewGbqSrlaIeWvlVL6Q/WkHIw6V9mgh71mDQG1bh4Z6LK913+xwnsDXY281//vynkkn8AoqClkclbLn4npsPcHJtRPtfYApzbZx3BYNO0nUXgic8zUiFt6DEIyBsiWBvDcVHWuVMgQ6VfNSWqdNDIwMW/B4HeBz0HOh/tvMKSS1beb3DHQsYGjefIZOAaPOXQUS9f9b631D9uGr4hNMLHPX/1k9SszGUCSB7J6wxcDRESNeRmGA/KCA5LtqRaURRfUBeiCb2FTUIsR3ywDT6c03TrjsKNBoHbQu89opV2H+9xWOpSWnxh4OWjheLzoUz7seD2Z4Xi86dPCU46hR+2sMvT1iqwy9GijrDL0YGVWyS3+8HhKr2sQx41D1mi8Fxoz6QJd1xxUo+nJFYJHgRljzb/UhvZpImXA3Bslw2+ltDRZIcqBsW9tA2P/eIXg4ca+dbPa0D7NGBuvQgV7f2OF6Af2Ht4F9v7WCsHD7T28oDa0j0t7a1aRqnX6N/xR3YlmZLjWRDMitHKiGVlQPQ+6RRPNyImS079qabzo1IvXAJgCUM7gST3crtLETJKEN/GFUMbQTNJQ4E/VWZHNrzCQZuhd8GijaiSMZBZezVqZnoTDYHfQn4ShRSARjoO5hXEALI8hLkyKejic10vhvK5mC/JfU40Ylx8qyD/qyD+1VPkRpVR+pNQckU2L8iMby+VHHP0jxfqTyBNZplGDL5kGa0JXxU/NESKRzfYbLCU8/6NHdu+eXvf90Pm/SWfvuD656+VLn6Qvar6Tv/newLb/ZpQnj7z5/vjfe158Wbjt/3RV4JAFKQAA';
var zlib = require("zlib");
var abi = JSON.parse(zlib.gunzipSync(Buffer.from(abiB64, "base64")).toString()); 
var bin = '0x' + zlib.gunzipSync(Buffer.from(binB64, "base64")).toString("hex");

let Web3 = require("web3");
let ethereumjsWallet = require("ethereumjs-wallet");
let ethereumjsUtil = require("ethereumjs-util");
let ethereumjsTx = require("ethereumjs-tx");
let sha256 = require("sha256");
let EthCrypto = require("eth-crypto");
let exec = require("child_process").exec;

let web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));

let healthContract = web3.eth.Contract(abi);
web3.personal.unlockAccount(web3.eth.accounts[0]);

let health = healthContract.new({
    from: web3.eth.accounts[0],
    data: bin,
    gas: 4700000
}, function(e, contract) {
    if(typeof contract.address === 'undefined') {
        return;
    }
    let healthContractInstance = healthContract.at(contract.address);
    let patient_wallet = ethereumjsWallet.generate();
    let patient_wallet_pub = patient_wallet.getPublicKey().toString("hex");
    let patient_wallet_priv = patient_wallet.getPrivateKey().toString("hex");
    let patient_wallet_address = patient_wallet.getAddressString();
    let data = healthContractInstance.addPatient.getData(patient_wallet_pub);
    let nonce = web3.eth.getTransactionCount(patient_wallet_address);
    let rawTx = {
        gasPrice: web3.toHex(web3.eth.gasPrice),
        gasLimit: web3.toHex(4700000),
        from: patient_wallet_address,
        nonce: web3.toHex(nonce),
        data: data,
        to: contract.address
    };
    let privateKey = ethereumjsUtil.toBuffer("0x" + patient_wallet_priv, "hex");
    let tx = new ethereumjsTx(rawTx);
    tx.sign(privateKey);
    web3.eth.sendRawTransaction("0x" + tx.serialize().toString("hex"),function(error, result){
        if (error) {
            console.log(error);
            res.status(500).send({error: "An Error occured"});
        } else {
            let pubFromContract = healthContractInstance.getPatientPublicKey.call(patient_wallet_address);
            console.log("Patient pub key: " + pubFromContract);
            let hospital_wallet = ethereumjsWallet.generate();
            let hospital_wallet_pub = hospital_wallet.getPublicKey().toString("hex");
            let hospital_wallet_priv = hospital_wallet.getPrivateKey().toString("hex");
            let hospital_wallet_address = hospital_wallet.getAddressString();
            let data = healthContractInstance.addPatient.getData(hospital_wallet_pub);
            let nonce = web3.eth.getTransactionCount(hospital_wallet_address);
            let rawTx = {
                gasPrice: web3.toHex(web3.eth.gasPrice),
                gasLimit: web3.toHex(4700000),
                from: hospital_wallet_address,
                nonce: web3.toHex(nonce),
                data: data,
                to: healthContractInstance.address
            };
            let privateKey = ethereumjsUtil.toBuffer("0x" + hospital_wallet_priv, "hex");
            let tx = new ethereumjsTx(rawTx);
            tx.sign(privateKey);
            web3.eth.sendRawTransaction("0x" + tx.serialize().toString('hex'), function(error, result){
                if (error) {
                    console.log(error);
                } else {
                    let getSvcProvPub = healthContractInstance.getServiceProviderPublicKey.call;
                    console.log("Hospital Pub Key: " + getSvcProvPub(hospital_wallet_address));
                    let token = "yr238932";
                    let tokenHash = "0x" + sha256(token);
                    let temp_wallet = ethereumjsWallet.generate();
                    let prePrefix = new Buffer([0x00]);
                    let secKeyA = Buffer.concat([prePrefix, patient_wallet.getPrivateKey()]).toString("base64");
                    let tmpPriv = temp_wallet.getPrivateKey();
                    let secKeyB = Buffer.concat([prePrefix, tmpPriv]).toString("base64");
                    exec("python3 ./generate_reEncKey.py " + secKeyA + " " + secKeyB, function(error, stdout, stderr){
                        if (error !== null) {
                            console.log(error);
                        } else {
                            let reEncKey = stdout.substr(2).slice(0, -2);
                            console.log("Re-encryption Key: " + reEncKey);
                            let data = healthContractInstance.addToken.getData(tokenHash, true, true, reEncKey);
                            let nonce = web3.eth.getTransactionCount(patient_wallet.getAddressString());
                            let rawTx = {
                                gasPrice: web3.toHex(web3.eth.gasPrice),
                                gasLimit: web3.toHex(4700000),
                                from: patient_wallet_address,
                                nonce: web3.toHex(nonce),
                                data: data,
                                to: healthContractInstance.address
                            };
                            let privateKey = ethereumjsUtil.toBuffer("0x" + patient_wallet_priv, "hex");
                            let tx = new ethereumjsTx(rawTx);
                            tx.sign(privateKey);
                            web3.eth.sendRawTransaction("0x" + tx.serialize().toString("hex"), function(error, result) {
                                if (error) {
                                    console.log(error);
                                } else {
                                    ((from, call) => {
                                        console.log("Token info: " + call(from, tokenHash, {from}));
                                    })(patient_wallet.getAddressString(), healthContractInstance.getToken.call);
                                    
                                    //get access to patient data
                                    let data = healthContractInstance.requestAccess.getData(token, patient_wallet.getAddressString());
                                    let nonce = web3.eth.getTransactionCount(hospital_wallet.getAddressString());
                                    let rawTx = {
                                        gasPrice: web3.toHex(web3.eth.gasPrice),
                                        gasLimit: web3.toHex(4700000),
                                        from: hospital_wallet.getAddressString(),
                                        nonce: web3.toHex(nonce),
                                        data: data,
                                        to: healthContractInstance.address
                                    };

                                    let privateKey = ethereumjsUtil.toBuffer("0x" + hospital_wallet.getPrivateKey().toString("hex"), "hex");
                                    let tx = new ethereumjsTx(rawTx);
                                    tx.sign(privateKey);

                                    web3.eth.sendRawTransaction("0x" + tx.serialize().toString("hex"), function(error, result){
                                        if (error) {
                                            console.log(error);
                                        } else {
                                            ((meth, call) => {
                                                console.log("Permission Info: " + call(patient_wallet[meth](), 
                                                                                       hospital_wallet[meth](), 
                                                                                       {from:hospital_wallet[meth]()}));
                                            })("getAddressString", healthContractInstance.getPermission.call);
                                            let emr = JSON.stringify({"Blood Group": "O+","type": "Blood Report"});
                                            let emrHash = sha256(emr);
                                            let data = healthContractInstance.addEMR.getData(patient_wallet.getAddressString(), emrHash);
                                            let nonce = web3.eth.getTransactionCount(hospital_wallet.getAddressString());
                                            let rawTx = {
                                                gasPrice: web3.toHex(web3.eth.gasPrice),
                                                gasLimit: web3.toHex(4700000),
                                                from: hospital_wallet.getAddressString(),
                                                nonce: web3.toHex(nonce),
                                                data: data,
                                                to: healthContractInstance.address
                                            };           
                                            let privateKey = ethereumjsUtil.toBuffer("0x" + hospital_wallet.getPrivateKey().toString("hex"), "hex");
                                            let tx = new ethereumjsTx(rawTx);
                                            tx.sign(privateKey);
        
                                            web3.eth.sendRawTransaction("0x" + tx.serialize().toString("hex"), function(error, result){
                                                if (error) {
                                                    console.log(error);
                                                } else {
                                                    var prefix = new Buffer([0x01]);
                                                    var patientPrivHex = patient_wallet.getPublicKey().toString("hex");
                                                    var patientPriv = EthCrypto.publicKey.compress(patientPrivHex);
                                                    var postfix = Buffer.from(patientPriv, "hex");
                                                    let compressedPublicKey = Buffer.concat([prefix, postfix]).toString("base64");
                                                    exec("python3 ./encrypt.py " + compressedPublicKey + " '" + emr + "'", function(error, stdout, stderr){
                                                        if (error !== null) {
                                                            console.log(error);
                                                        } else {
                                                            let encryptedEMR = stdout.substr(2).slice(0, -2);
                                                            console.log("Encrypted Message: " + encryptedEMR);
                                                            exec("python3 ./re_encrypt.py " + reEncKey + " " + encryptedEMR, function(error, stdout, stderr){
                                                                if (error !== null) {
                                                                    console.log(error);
                                                                } else {
                                                                    let reEncryptedEMR = stdout.substr(2).slice(0, -2);
                                                                    console.log("Re-Encrypted Message: " + reEncryptedEMR);
                                                                    exec("python3 ./decrypt.py " + secKeyB + " " + reEncryptedEMR, function(error, stdout, stderr){
                                                                        if (error !== null) {
                                                                            console.log(error);
                                                                        } else {
                                                                            let decrypted_message = stdout.substr(2).slice(0, -2);
                                                                            console.log("Decrypted Message: " + decrypted_message);
                                                                            let new_patient_wallet = ethereumjsWallet.generate();
                                                                            var [secKeyA, secKeyB] = [patient_wallet, new_patient_wallet].map(wallet => Buffer.concat([new Buffer([0x00]), wallet.getPrivateKey()]).toString("base64"));
                                                                            exec("python3 ./generate_reEncKey.py " + secKeyA + " " + secKeyB, function(error, stdout, stderr){
                                                                                if (error !== null) {
                                                                                    console.log(error);
                                                                                } else {
                                                                                    let reEncKey = stdout.substr(2).slice(0, -2);
                                                                                    console.log("Re-encryption Key for Patients new wallet" + reEncKey);
                                                                                    /////////////////
                                                                                    let data = healthContractInstance.changePatientAccount.getData(reEncKey, new_patient_wallet.getAddressString(), new_patient_wallet.getPublicKey().toString("hex"));
                                                                                    let nonce = web3.eth.getTransactionCount(patient_wallet.getAddressString());
                                                                                    let rawTx = {
                                                                                        gasPrice: web3.toHex(web3.eth.gasPrice),
                                                                                        gasLimit: web3.toHex(4700000),
                                                                                        from: patient_wallet.getAddressString(),
                                                                                        nonce: web3.toHex(nonce),
                                                                                        data: data,
                                                                                        to: healthContractInstance.address
                                                                                    };           
                                                                                    let privateKey = ethereumjsUtil.toBuffer("0x" + patient_wallet.getPrivateKey().toString("hex"), "hex");
                                                                                    let tx = new ethereumjsTx(rawTx);
                                                                                    tx.sign(privateKey);
                                                                                    web3.eth.sendRawTransaction("0x" + tx.serialize().toString("hex"), function(error, result){
                                                                                        if (error) {
                                                                                            console.log(error);
                                                                                        } else {
                                                                                            let events = healthContractInstance.allEvents({fromBlock: 0, toBlock:"latest"});
                                                                                            events.get(function(error, logs){
                                                                                                for (let count = 0; count < logs.length; count++) {
                                                                                                    console.log("Event Name:" + logs[count].event + "and Args: " + JSON.stringify(logs[count].args));
                                                                                                }
                                                                                            });
                                                                                        }
                                                                                    })
                                                                                    /////////////////
                                                                                }
                                                                            })
                                                                        }
                                                                    })
                                                                }
                                                            })
                                                        }
                                                    })
                                                }                                                                           
                                        }
                                    })

                                }
                            })

                        }
                    });
                }
            });

            //==================================
            //continue from here
            //==================================
        }
    });
});